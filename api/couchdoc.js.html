<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Lounge</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.3/normalize.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700" type="text/css">
    <link rel="stylesheet" href="css/bootstrap.css">
    <link rel="stylesheet" href="css/cayman.css">
    <link rel="stylesheet" href="css/prism.css">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Lounge</h1>
      <h2 class="project-tagline">Simple Mongoose-inspired ODM for Couchbase</h2><a href="https://github.com/bojand/lounge" target="_blank" class="btn">View on GitHub</a><a href="https://npmjs.com/package/lounge" target="_blank" class="btn">View on npm</a>
    </section>
    <section data-spy="scroll" data-target=".scrollspy" class="main-content">
      <div class="row">
        <div class="col-md-3 col-xs-3 bs-docs-sidebar">
          <ul id="sidebar" class="nav nav-stacked fixed">
            <li><a href="index.html">Main</a></li>
            <li class="active"><a href="couchdoc.js.html">couchdoc.js
                <ul class="nav nav-stacked">
                  <li><a href="#CouchbaseDocument"><i class="alert alert-success"></i><span>CouchbaseDocument</span></a>
                  </li>
                  <li><a href="#__proto__"><i class="alert alert-success"></i><span>__proto__</span></a>
                  </li>
                  <li><a href="#db"><i class="alert alert-success"></i><span>db</span></a>
                  </li>
                  <li><a href="#bucket"><i class="alert alert-success"></i><span>bucket</span></a>
                  </li>
                  <li><a href="#getCAS"><i class="alert alert-info"></i><span>getCAS</span></a>
                  </li>
                  <li><a href="#save"><i class="alert alert-info"></i><span>save</span></a>
                  </li>
                  <li><a href="#index"><i class="alert alert-info"></i><span>index</span></a>
                  </li>
                  <li><a href="#remove"><i class="alert alert-info"></i><span>remove</span></a>
                  </li>
                  <li><a href="#removeIndexes"><i class="alert alert-info"></i><span>removeIndexes</span></a>
                  </li>
                  <li><a href="#findById"><i class="alert alert-info"></i><span>findById</span></a>
                  </li>
                </ul></a></li>
            <li><a href="document.js.html">document.js</a></li>
            <li><a href="driver.js.html">driver.js</a></li>
            <li><a href="index.js.html">index.js</a></li>
            <li><a href="model.js.html">model.js</a></li>
            <li><a href="schema.js.html">schema.js</a></li>
            <li><a href="tree.js.html">tree.js</a></li>
            <li><a href="type.js.html">type.js</a></li>
            <li><a href="utils.js.html">utils.js</a></li>
          </ul>
        </div>
        <div class="col-md-9">
          <section id="CouchbaseDocument">
            <h1>CouchbaseDocument</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-success radius ctx-type">constructor</div><span>&nbsp;</span><span>CouchbaseDocument()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>data</td>
                <td>Object</td>
                <td><p>the document data</p></td>
              </tr>
              <tr>
                <td>cas</td>
                <td>Object</td>
                <td><p>the document CAS value from Couchbase</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>CouchbaseDocument inherits Document and handles all the database related actions.<br />Clients should never have to call this directly.</p></div>
          <pre><code class="language-javascript">function CouchbaseDocument(data, cas) {
  var self = this;

  this.$_casv = cas;
  this.$_o = {
    refValues: {},
    key: null
  };

  utils.define(this, 'cas', {
    get: function () {
      return self.getCAS();
    }
  });

  Document.apply(this, arguments);

  _.merge(this.$_o.refValues, this.$_buildRefValues(data));
  this.$_o.key = this.getDocumentKeyValue();
}</code></pre>
          <section id="__proto__">
            <h1>__proto__</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-success radius ctx-type">property</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.__proto__</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Inherits from Document.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.__proto__ = Document.prototype;

var k;
for (k in Document) {
  CouchbaseDocument[k] = Document[k];
}</code></pre>
          <section id="db">
            <h1>db</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-success radius ctx-type">property</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.db</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Connection the model uses. <code>Driver</code> instance.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.db;</code></pre>
          <section id="bucket">
            <h1>bucket</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-success radius ctx-type">property</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.bucket</span><span>&nbsp;</span>
            </p>
          </section>
          <div class="description"><p>Couchbase Bucket the model uses.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.bucket;</code></pre>
          <section id="getCAS">
            <h1>getCAS</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.getCAS()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>raw</td>
                <td>Boolean</td>
                <td><p>If <code>true</code> returns the raw CAS document. If <code>false</code> returns string representation of CAS.                  Defaults to <code>false</code>.</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Returns the document CAS value.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.getCAS = function (raw) {
  if (raw) {
    return this.$_casv;
  }

  var v = '';
  var cas = this.$_casv;

  if (typeof cas === 'object') {
    var p;
    for (p in cas) {
      if (cas.hasOwnProperty(p) &amp;&amp; cas[p]) {
        if (Buffer.isBuffer(cas[p])) {
          v = v.concat(cas[p].toString('hex'));
        }
        else {
          v = v.concat(cas[p].toString())
        }
      }
    }
  }

  if (cas &amp;&amp; (!v || !v.trim().length)) {
    v = cas.toString();
  }

  return v;
};</code></pre>
          <section id="save">
            <h1>save</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.save()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>data</td>
                <td>Object</td>
                <td><p>Optional. Sets the objects data.</p></td>
              </tr>
              <tr>
                <td>options</td>
                <td>Object</td>
                <td><p>The save options. All options not present here are first looked up from schema options, and then from config options.</p><ul>
<li><code>storeFullReferenceId</code> - whether to save embedded document property values as full document keys or just the base value</li>
<li><code>storeFullKey</code> - whether to save the internal document key property as fully expanded value or as the simple value</li>
<li><code>refIndexKeyPrefix</code> - lookup index document key prefix.</li>
<li><code>waitForIndex</code> - whether we want to wait for indexing to finish before returning. default is false.</li>
<li><code>virtuals</code> - whether we want to save virtuals. default is false.</li>
<li><code>minimize</code> - to &quot;minimize&quot; the document by removing any empty properties. Default: true</li>
<li><code>expiry</code> - couchbase upsert option</li>
<li><code>persist_to</code> - couchbase persist_to option</li>
<li><code>replicate_to</code> - couchbase option</li>
</ul>
</td>
              </tr>
              <tr>
                <td>fn</td>
                <td>Function</td>
                <td><p>callback</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Save the current model instance. Calls db set function for the model id and saves the properties.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.save = function (data, options, fn) {
  if (typeof options === 'function') {
    fn = options;
    options = {};
  }

  if (typeof data === 'function') {
    fn = data;
    data = null;
    options = {};
  }

  if (!fn) {
    fn = utils.noop;
  }

  if (!options) {
    options = {};
  }

  options = _.defaults(options,
    _.pick(this.schema.options, utils.saveOptionsKeys),
    _.pick(this.config, utils.saveOptionsKeys));

  if (process.env.LOUNGE_DEBUG_FORCE_SAVE_FAIL) {
    return process.nextTick(function () {
      return fn(new Error('Forced save error'));
    })
  }

  var self = this;

  if (data) {
    var dataProp;
    for (dataProp in data) {
      if (data.hasOwnProperty(dataProp)) {
        self.set(dataProp, data[dataProp]);
      }
    }
  }

  var changedRefs = [];

  // iteratively save the refs
  var refs = this.$_getSoretedRefPaths(true);
  if (refs &amp;&amp; refs.length &gt; 0) {
    async.eachLimit(refs, 10, function (path, eachCB) {
      var thing = mpath.get(path, self, '$_table');

      if (_.isUndefined(thing) || _.isNull(thing)) {
        eachCB();
      }

      if (!utils.isArray(thing)) {
        if (thing instanceof CouchbaseDocument) {
          changedRefs.push({
            path: path,
            value: thing
          });
        }

        self.$_saveRefField(self, path, thing, options, eachCB);
      }
      else if (utils.isArray(thing)) {
        var idArray = [];
        async.forEachOfLimit(thing, 10, function (thingDoc, key, arrayCB) {
          if (thingDoc instanceof CouchbaseDocument) {
            changedRefs.push({
              path: path.concat('.', key),
              value: thingDoc
            });
          }

          self.$_saveRefField(idArray, path, thingDoc, options, arrayCB);
        }, function finalArrayCB(err) {
          if (!err) {
            mpath.set(path, idArray, self, '$_table');
          }
          return eachCB(err);
        });
      }
    }, function finalCB(err) {
      if (err) {
        return fn(err);
      }
      else {
        self.$_indexAndSave(changedRefs, options, fn);
      }
    });
  }
  else {
    this.$_indexAndSave(changedRefs, options, fn);
  }
};</code></pre>
          <section id="index">
            <h1>index</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.index()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>options</td>
                <td>Object</td>
                <td><ul>
<li><code>storeFullReferenceId</code> - whether we store full document id in reference documents</li>
</ul>
</td>
              </tr>
              <tr>
                <td>fn</td>
                <td>Function</td>
                <td><p>callback</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Update all lookup documents for this document instance. Creates new lookup documents for properties that have changed<br />and deletes the old ones not needed any more.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.index = function (options, fn) {
  var defaults = {
    storeFullReferenceId: _.isUndefined(this.schema.options.storeFullReferenceId) ?
      this.config.storeFullReferenceId : this.schema.options.storeFullReferenceId
  };

  if (typeof options === 'function') {
    fn = options;
    options = defaults;
  }

  if (!fn || typeof fn !== 'function') {
    fn = _.noop;
  }

  options = _.defaults(options || {}, defaults);

  var self = this;

  var currentRefValues = this.$_buildRefValues(this.$_table);

  var fieldsToRef = buildIndexObjects(this.$_o.refValues, currentRefValues);

  async.eachLimit(fieldsToRef, 10, function (refObj, eaCb) {
    self.$_indexField(refObj, options, eaCb);
  }, function (err) {
    self.emit('index', err);
    return fn(err);
  });
};</code></pre>
          <section id="remove">
            <h1>remove</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.remove()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>options</td>
                <td>Object</td>
                <td><p>Options to be passed to the Couchbase <code>Bucket.remove()</code> function.</p></td>
              </tr>
              <tr>
                <td>fn</td>
                <td>Function</td>
                <td><p>callback</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Removes the instance from the database.<br />Calls the bucket <code>remove()</code> function. Options can be passed to the driver.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.remove = function (options, fn) {
  if (typeof options === 'function') {
    fn = options;
    options = {};
  }

  if (!fn) {
    fn = utils.noop;
  }

  if (!options) {
    options = {};
  }

  if (process.env.LOUNGE_DEBUG_FORCE_REMOVE_FAIL) {
    return process.nextTick(function () {
      return fn(new Error('Forced remove error'));
    })
  }

  var self = this;

  if (options.removeRefs === true) {
    var refs = this.$_getSoretedRefPaths(true);
    if (refs &amp;&amp; refs.length &gt; 0) {
      async.eachLimit(refs, 10, function (path, eachCB) {
        var thing = mpath.get(path, self, '$_table');

        if (_.isUndefined(thing) || _.isNull(thing)) {
          return eachCB();
        }

        if (!utils.isArray(thing)) {
          return self.$_removeRefField(self, path, thing, options, eachCB);
        }
        else if (utils.isArray(thing)) {
          var idArray = [];
          async.forEachOfLimit(thing, 10, function (thingDoc, key, arrayCB) {
            self.$_removeRefField(idArray, path, thingDoc, options, arrayCB);
          }, eachCB);
        }
        else {
          eachCB();
        }
      }, function finalCB(err) {
        if (err) {
          return fn(err);
        }
        else {
          self.$_remove(options, fn);
        }
      });
    }
    else {
      self.$_remove(options, fn);
    }
  }
  else {
    self.$_remove(options, fn);
  }
};</code></pre>
          <section id="removeIndexes">
            <h1>removeIndexes</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.prototype.removeIndexes()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>options</td>
                <td>Object</td>
                <td><ul>
<li><code>storeFullReferenceId</code> - whether we store full document id in reference documents</li>
</ul>
</td>
              </tr>
              <tr>
                <td>fn</td>
                <td>Function</td>
                <td><p>callback</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Removes all lookup / index documents for this document.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.prototype.removeIndexes = function (options, fn) {
  var defaults = {
    storeFullReferenceId: _.isUndefined(this.schema.options.storeFullReferenceId) ?
      this.config.storeFullReferenceId : this.schema.options.storeFullReferenceId
  };

  if (typeof options === 'function') {
    fn = options;
    options = defaults;
  }

  if (!fn || typeof fn !== 'function') {
    fn = _.noop;
  }

  options = _.defaults(options || {}, defaults);

  var self = this;

  var currentRefValues = this.$_buildRefValues(this.$_table);

  var toRemove = _.union(_.values(currentRefValues), _.values(this.$_o.refValues));

  // flatten arrays
  var toRemove2 = [];
  toRemove.forEach(function (e) {
    if (typeof e.value === 'string' || typeof e.value === 'string') {
      toRemove2.push(e);
    }
    else if (Array.isArray(e.value)) {
      e.value.forEach(function (ve) {
        toRemove2.push({
          path: e.path,
          value: ve,
          name: e.name
        });
      });
    }
  });

  // uniq
  var uniq = _.uniq(toRemove2, function (e) {
    var p = e.path || '';
    var v = e.value || '';
    var n = e.name || '';
    return ''.concat(p, v, n);
  });

  async.eachLimit(uniq, 10, function (u, eaCb) {
    u.action = 'remove';
    self.$_indexField(u, options, eaCb);
  }, fn);
};</code></pre>
          <section id="findById">
            <h1>findById</h1>
            <h5 class="subheader"></h5>
            <p>
              <div class="label label-info radius ctx-type">method</div><span>&nbsp;</span><span>CouchbaseDocument.findById()</span><span>&nbsp;</span>
            </p>
          </section>
          <table class="table table-bordered table-striped">
            <thead>
              <tr>
                <th style="width:20%">Option name</th>
                <th style="width:20%">Type</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>id</td>
                <td>String</td>
                <td><p>the document id / key</p></td>
              </tr>
              <tr>
                <td>options</td>
                <td>Object</td>
                <td><ul>
<li><code>populate</code> - populate options, can be a <code>Boolean</code>, <code>String</code> representing a path, or an <code>Array</code> of <code>String</code> paths</li>
</ul>
</td>
              </tr>
              <tr>
                <td>fn</td>
                <td>Function</td>
                <td><p>callback</p></td>
              </tr>
            </tbody>
          </table>
          <div class="description"><p>Find a document by key value.</p></div>
          <pre><code class="language-javascript">CouchbaseDocument.findById = function (id, options, fn) {
  var self = this;

  if (typeof options === 'function') {
    fn = options;
    options = {};
  }

  if (!options) {
    options = {};
  }

  if (!fn) {
    fn = utils.noop;
  }

  if (this.config.alwaysReturnArrays &amp;&amp; !Array.isArray(id)) {
    id = [id];
  }

  if (Array.isArray(id)) {
    id = _.compact(id);
  }

  if (!id || _.isEmpty(id)) {
    return process.nextTick(function () {
      return fn(null, null, []);
    })
  }

  if (Array.isArray(id)) {
    var fullIds = _.map(id, function (curId) {
      return self.getDocumentKeyValue(curId, true);
    });

    self.db.get(fullIds, function (err, results, misses) {
      if (err) {
        return fn(err, results, misses);
      }

      if (!results || results.length === 0) {
        return fn(err, [], misses);
      }

      var modelObjs = _.map(results, self.$_createModelObject, self);
      async.eachLimit(modelObjs, 10, function (modelObj, eachCB) {
        modelObj.$_populate(options, function (err, popObj, missed) {
          misses = misses.concat(missed);
          return eachCB(err);
        });
      }, function (err) {
        return fn(err, modelObjs, misses);
      });
    });
  }
  else {
    id = this.getDocumentKeyValue(id, true);
    self.db.get(id, function (err, getRes) {
      if (err) {
        return fn(err);
      }

      var modelObj = self.$_createModelObject(getRes);
      if (!modelObj) {
        return fn(new Error('no document for id: ' + id));
      }

      modelObj.$_populate(options, fn);
    });
  }
};</code></pre>
          <div class="footer site-footer">
            <div class="span site-footer-owner"><a href="https://github.com/mr-doc/mr-doc-theme-cayman">Cayman</a> is maintained by <a href="https://github.com/iwatakeshi">iwatakeshi</a>.</div>
            <div class="span site-footer-credits">This page was generated by <a href="https://github.com/mr-doc/mr-doc">Mr. Doc</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</div>
          </div>
        </div>
      </div>
    </section>
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/affix.js"></script>
    <script src="js/dropdown.js"></script>
    <script src="js/scrollspy.js"></script>
    <script src="js/prism.js"></script>
    <script src="js/prism-bash.js"></script>
    <script>
      $(document).ready(function(){
        $('body').scrollspy({
          target: ".bs-docs-sidebar",
          offset: 40
        });
        $('#sidebar').affix({
          offset:{
            bottom:60,
            top: 60
          }
        }) 
      });
    </script>
  </body>
</html>