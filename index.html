<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Lounge by bojand</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Lounge</h1>
      <h2 class="project-tagline">Simple Mongoose-inspired ODM for Couchbase.</h2>
      <a href="https://github.com/bojand/lounge" class="btn">View on GitHub</a>
      <a href="https://github.com/bojand/lounge/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/bojand/lounge/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="lounge" class="anchor" href="#lounge" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge</h1>

<p>Simple Mongoose-inspired ODM for <a href="http://www.couchbase.com">Couchbase</a>.</p>

<h2>
<a id="installation" class="anchor" href="#installation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation</h2>

<p><code>npm install lounge</code></p>

<h2>
<a id="stability" class="anchor" href="#stability" aria-hidden="true"><span class="octicon octicon-link"></span></a>Stability</h2>

<p>This module is under development and there could be bugs. API may not be 100% locked down. 
Documentation is still work in progress.</p>

<h2>
<a id="overview" class="anchor" href="#overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>Overview</h2>

<p>Lounge is a simple, somewhat opinionated, Mongoose-inspired ODM for <a href="http://www.couchbase.com">Couchbase</a>. Main goal is
to provide modeling tool framework for working with Couchbase databases in an asynchronous environment of Node.js. </p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);
<span class="pl-smi">lounge</span>.<span class="pl-en">connect</span>(<span class="pl-s"><span class="pl-pds">'</span>couchbase://127.0.0.1<span class="pl-pds">'</span></span>);

<span class="pl-k">var</span> schema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({ name<span class="pl-k">:</span> <span class="pl-c1">String</span> });
<span class="pl-k">var</span> Cat <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>Cat<span class="pl-pds">'</span></span>, schema);

<span class="pl-k">var</span> kitty <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Cat</span>({ name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Zildjian<span class="pl-pds">'</span></span> });
<span class="pl-smi">kitty</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span> (<span class="pl-smi">err</span>) {
  <span class="pl-k">if</span> (err) <span class="pl-c">// ...</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>meow<span class="pl-pds">'</span></span>);
});</pre></div>

<h5>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span class="octicon octicon-link"></span></a>Features:</h5>

<ul>
<li>Schema definition</li>
<li>Strict modelling based on schema</li>
<li>Schema extension</li>
<li>Automatic type validation and custom validation</li>
<li>Document upsert and removal</li>
<li>Embedded (referenced) documents</li>
<li>Automatic and manual population of embedded (referenced) document</li>
<li>Middleware including pre and post hooks</li>
<li>Indexing using <a href="http://docs.couchbase.com/developer/dev-guide-3.0/lookups.html">reference lookup documents</a>
</li>
</ul>

<h5>
<a id="outside-of-the-scope-of-this-module" class="anchor" href="#outside-of-the-scope-of-this-module" aria-hidden="true"><span class="octicon octicon-link"></span></a>Outside of the scope of this module:</h5>

<ul>
<li>Document and view management. There are two many patterns and ways of performing document and view management and 
view lookup that it is impractical to accomplish anything sane within a simple ODM. This can easily be expanded
on top of Lounge.</li>
<li>View queries. For same reasons this falls outside of the scope of Lounge.</li>
<li>Automatic document removal on key change. That is if a document key property changes, the new document is saved under
the new key. The old document sticks around under the old key. There are too many implications if we start automatically
handle document removal in this scenario. This should be handled by the user of this module.</li>
</ul>

<h2>
<a id="documentation" class="anchor" href="#documentation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Documentation</h2>

<ul>
<li><a href="#lounge">Setup</a></li>
<li><a href="#model">Modelling</a></li>
<li><a href="#middleware">Middleware</a></li>
<li><a href="#schema-extend">Schema Extension</a></li>
<li><a href="#embedded">Embedded Documents</a></li>
<li><a href="#saving">Saving Documents</a></li>
<li><a href="#removing">Removing Documents</a></li>
<li><a href="#population">Population</a></li>
<li><a href="#indexes">Indexes</a></li>
<li><a href="#queries">Queries</a></li>
<li><a href="#events">Events</a></li>
</ul>

<h3>
<a id="setup-" class="anchor" href="#setup-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setup <a id="lounge"></a>
</h3>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);</pre></div>

<p>Module exports an instance of <code>Lounge</code> class.</p>

<h4>
<a id="loungeoptions" class="anchor" href="#loungeoptions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge(options)</h4>

<p>Creates a new instance of <code>Lounge</code> class. You rarely have to do this.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);
<span class="pl-k">var</span> l <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">lounge.Lounge</span>();</pre></div>

<p><strong>Options</strong></p>

<ul>
<li>
<code>keyPrefix</code> - key prefix for all keys. No default. Generally useful if you wish to namespace documents. 
Example: <code>app::env::</code>.</li>
<li>
<code>storeFullReferenceId</code> - whether to store embedded document keys as fully expanded keys 
(with prefix and suffix applied) or just the minimized version. default: <code>false</code>. </li>
<li>
<code>storeFullKey</code> - Similarly, to store the fully expanded document key inside the key property. default: <code>false</code>
</li>
<li>
<code>alwaysReturnArrays</code> - set to true to force <code>findyById</code> to always return an array of documents even if only
a single key is passed in. Default: <code>false</code>
</li>
<li>
<code>refIndexKeyPrefix</code> - reference lookup index document key prefix. The name of the index is appended to this.
Default: <code>'$_ref_by_'</code>
</li>
<li>
<code>delimiter</code> - delimiter string used for concatenation in reference document key expansion / generation. default: <code>'_'</code> 
This is prepended to the reference document key.</li>
<li>
<code>waitForIndex</code> - When documents are saved, indexes are updated. We can wait for this operation to finish before 
returning from <code>save()</code>. Default: <code>false</code>
</li>
<li>
<code>minimize</code> - "minimize" schemas by removing empty objects. Default: <code>true</code>
</li>
</ul>

<p>Any of these options, or additional variables can be manipulated using the <code>setOption</code> and <code>getOption</code> methods.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);
<span class="pl-smi">lounge</span>.<span class="pl-en">setOption</span>(<span class="pl-s"><span class="pl-pds">'</span>alwaysReturnArrays<span class="pl-pds">'</span></span>, <span class="pl-c1">true</span>);
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">lounge</span>.<span class="pl-en">getOption</span>(<span class="pl-s"><span class="pl-pds">'</span>alwaysReturnArrays<span class="pl-pds">'</span></span>);</pre></div>

<h4>
<a id="loungeconnectoptions-fn-mock" class="anchor" href="#loungeconnectoptions-fn-mock" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.connect(options, fn, mock)</h4>

<p>Connects to the database cluster based on <code>options</code>. When completed calls <code>fn</code> callback. Set <code>mock</code> to <code>true</code> to use
<a href="https://github.com/couchbase/couchnode#mock-testing">Couchbase mocking</a>. Alternatively you can set
<code>LOUNGE_COUCHBASE_MOCK</code> environment variable.</p>

<p><strong>Options</strong></p>

<ul>
<li>
<code>connectionString</code> - connection string for the cluster. See <a href="http://docs.couchbase.com/sdk-api/couchbase-node-client-2.1.2/Cluster.html">Cluster documentation</a>.</li>
<li>
<code>bucket</code> - name of the bucket to be used for <a href="http://docs.couchbase.com/sdk-api/couchbase-node-client-2.1.2/Cluster.html#openBucket"><code>openBucket</code></a>
or the actual, already connected, Couchbase <code>bucket</code> instance.</li>
<li>
<code>password</code> - password for <a href="http://docs.couchbase.com/sdk-api/couchbase-node-client-2.1.2/Cluster.html#openBucket"><code>openBucket</code></a>
</li>
<li>
<code>certpath</code> - certpath for <a href="http://docs.couchbase.com/sdk-api/couchbase-node-client-2.1.2/Cluster.html">cluster constructor</a>.</li>
</ul>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);
<span class="pl-smi">lounge</span>.<span class="pl-en">connect</span>(<span class="pl-s"><span class="pl-pds">'</span>couchbase://127.0.0.1<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>) {
  <span class="pl-c">// ... connected</span>
});</pre></div>

<h4>
<a id="loungedisconnect" class="anchor" href="#loungedisconnect" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.disconnect()</h4>

<p>Disconnect from the bucket. Deletes all defined models.</p>

<h4>
<a id="loungeschemadescriptor-options" class="anchor" href="#loungeschemadescriptor-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.schema(descriptor, options)</h4>

<p>Creates a new <code>Schema</code> based on <code>descriptor</code> and <code>options</code>. Prefer this over the actual <code>Schema</code> constructor as this
will pass lounge config variables to the <code>Schema</code> constructor automatically. </p>

<p>Schema construction options:</p>

<ul>
<li>
<code>keyPrefix</code> - key prefix for all keys. No default. Generally useful if you wish to namespace documents. Example: <code>app::env::</code>.</li>
<li>
<code>keySuffix</code> - Similar as prefix but used as a suffix</li>
<li>
<code>refIndexKeyPrefix</code> - reference lookup index document key prefix. The name of the index is appended. Default: '$<em>ref_by</em>'</li>
<li>
<code>delimiter</code> - delimiter string used for concatenation in reference document key expansion / generation.
Default: '_'. This is prepended to the reference document key.
*<code>minimize</code> - "minimize" schemas by removing empty objects. Default: <code>true</code>
</li>
<li>
<code>toObject</code> - toObject method options: <code>transform</code>, <code>virtuals</code> and <code>minimize</code>
</li>
<li>
<code>toJSON</code> - toJSON method options, similar to above</li>
<li>
<code>strict</code> - ensures that value passed in ot assigned that were not specified in our schema do not get saved. Default: <code>true</code>
</li>
</ul>

<h4>
<a id="loungemodelname-schema-options" class="anchor" href="#loungemodelname-schema-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.model(name, schema, options)</h4>

<p>Defines a Model based on case sensitive model <code>name</code> and created <code>schema</code>, with given options. From there we can create
instances of the Model;</p>

<p><strong>Options</strong></p>

<ul>
<li>
<code>freeze</code> - to freeze the model. See <code>Object.freeze</code>. Default: <code>true</code>
</li>
</ul>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  dateOfBirth<span class="pl-k">:</span> <span class="pl-c1">Date</span>,
});

User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  firstName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Joe<span class="pl-pds">'</span></span>,
  lastName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Smith<span class="pl-pds">'</span></span>,
  email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>joe@gmail.com<span class="pl-pds">'</span></span>,
  dateOfBirth<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>()
});

<span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User) <span class="pl-c">// true</span></pre></div>

<h4>
<a id="loungemodelnames" class="anchor" href="#loungemodelnames" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.modelNames()</h4>

<p>Returns and array of all defined model names.</p>

<h4>
<a id="bucket-functions" class="anchor" href="#bucket-functions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Bucket functions</h4>

<p>Lounge instance also inherits all public <a href="http://docs.couchbase.com/sdk-api/couchbase-node-client-2.1.2/Bucket.html"><code>Bucket</code></a>
 functions and properties.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">lounge</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>mydocumentkey<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">res</span>) {
  <span class="pl-c">// .. save as if we did normal bucket.get()</span>
});</pre></div>

<h4>
<a id="loungeschema" class="anchor" href="#loungeschema" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.Schema</h4>

<p>Exported <code>Schema</code> constructor. You can use this as well as <code>lounge.schema()</code>, which is preferred.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">lounge.Schema</span>({ name<span class="pl-k">:</span> <span class="pl-c1">String</span> });</pre></div>

<h4>
<a id="loungemodel" class="anchor" href="#loungemodel" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.Model</h4>

<p>Exported <code>Model</code> constructor. You should never have to manually create a Model.</p>

<h4>
<a id="loungedocument" class="anchor" href="#loungedocument" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lounge.Document</h4>

<p>Exported  internal <code>Document</code> constructor. You should never have to manually create a Document.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-c">// already defined User model</span>
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob<span class="pl-pds">'</span></span>});
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User) <span class="pl-c">// true</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> <span class="pl-smi">lounge</span>.<span class="pl-smi">Model</span>) <span class="pl-c">// true</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> <span class="pl-smi">lounge</span>.<span class="pl-smi">Document</span>) <span class="pl-c">// true</span></pre></div>

<h3>
<a id="modelling-" class="anchor" href="#modelling-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Modelling <a id="model"></a>
</h3>

<p><strong>Basics</strong></p>

<p>We begin defining a data model using a schema.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  age<span class="pl-k">:</span> <span class="pl-c1">Number</span>,
  usernames<span class="pl-k">:</span> [<span class="pl-c1">String</span>],
  setup<span class="pl-k">:</span> <span class="pl-c1">Boolean</span>
  metadata<span class="pl-k">:</span> {
    createdAt<span class="pl-k">:</span> <span class="pl-c1">Date</span>,
    updatedAt<span class="pl-k">:</span> <span class="pl-c1">Date</span>
  }
});</pre></div>

<p>We can add additional properties using <code>add</code> function:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">userSchema</span>.<span class="pl-c1">add</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>, <span class="pl-c1">String</span>);</pre></div>

<p>Alternatively we can explicitly specify the type using <code>type</code> property:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> catSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-c1">String</span> }
  breed<span class="pl-k">:</span> <span class="pl-c1">String</span>,
});

<span class="pl-smi">catSchema</span>.<span class="pl-c1">add</span>(<span class="pl-s"><span class="pl-pds">'</span>age<span class="pl-pds">'</span></span>, {type<span class="pl-k">:</span> <span class="pl-c1">String</span>});</pre></div>

<p>Schema options can be set at construction or using the <code>set</code> function.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> catSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-c1">String</span> }
  breed<span class="pl-k">:</span> <span class="pl-c1">String</span>,
}, {
  keyPrefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>cat::<span class="pl-pds">'</span></span>
});

<span class="pl-smi">catSchema</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>refIndexKeyPrefix<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>::<span class="pl-pds">'</span></span>);</pre></div>

<p><strong>Document keys</strong></p>

<p>By defualt schemas come with an <code>id</code> property as the document key, and the automatically generated value will be
a <a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> 
using <a href="https://www.npmjs.com/package/node-uuid">node-uuid</a> <code>v4()</code> function. This should be most practical and most
appropriate in a lot of cases. Alternatively you can specify explicit key properties:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-c1">String</span>, key<span class="pl-k">:</span> <span class="pl-c1">true</span>, generate<span class="pl-k">:</span> <span class="pl-c1">false</span> }
});</pre></div>

<p>Here we desire <code>email</code> to be used as the document key and we specify <code>generate: false</code> because we do not want Lounge
to automatically handle key property value generation. If we still want uuid generation but in a different property 
we can specify so:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  userId<span class="pl-k">:</span> {type<span class="pl-k">:</span> <span class="pl-c1">String</span>, key<span class="pl-k">:</span> <span class="pl-c1">true</span>, generate<span class="pl-k">:</span> <span class="pl-c1">true</span> }
});</pre></div>

<p><code>generate</code> does not have to be set explicitly to <code>true</code> as that is the default.</p>

<p>We can specify additional prefix and/or suffix for keys. This will be used when wrigin to the database as the actual
document key.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-c1">String</span>, key<span class="pl-k">:</span> <span class="pl-c1">true</span>, generate<span class="pl-k">:</span> <span class="pl-c1">false</span>, prefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>user<span class="pl-pds">'</span></span>}
});</pre></div>

<p>Note that setting prefix and suffix options like this will take presidence over any <code>keyPrefix</code> and <code>keySuffix</code> 
options specified in the second options parameter to the <code>schema()</code> call or any settings in the lounge config.</p>

<p><strong>Examples</strong></p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);

<span class="pl-c">// ... connect</span>

<span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
  email<span class="pl-k">:</span> { type<span class="pl-k">:</span> <span class="pl-c1">String</span>, key<span class="pl-k">:</span> <span class="pl-c1">true</span>, generate<span class="pl-k">:</span> <span class="pl-c1">false</span>, prefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>user::<span class="pl-pds">'</span></span>}
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>, email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>bsmith@acme.com<span class="pl-pds">'</span></span>});
<span class="pl-smi">user</span>.<span class="pl-en">save</span>();</pre></div>

<p>This will save the user document under key <code>user::bsmith@acme.com</code>.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> lounge <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>lounge<span class="pl-pds">'</span></span>);

<span class="pl-c">// ... connect</span>

<span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
}, {
  keyPrefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>user::<span class="pl-pds">'</span></span>
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>});
<span class="pl-smi">user</span>.<span class="pl-en">save</span>();</pre></div>

<p>This will automatically generate a uuid <code>id</code> property and save the user document under key 
similar to <code>user::110ec58a-a0f2-4ac4-8393-c866d813b8d1</code>.</p>

<p><strong>Data manipulation</strong></p>

<p>Data in Model instances can be access directly or using <code>get</code> function. Similarly it can be manipulated using 
either assignment operator or using the <code>set</code> function. In either case the input value is validated to be of proper type.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
  friends<span class="pl-k">:</span> <span class="pl-c1">Number</span>,
  dob<span class="pl-k">:</span> <span class="pl-c1">Date</span>,
  setup<span class="pl-k">:</span> <span class="pl-c1">Boolean</span>
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>});

<span class="pl-smi">user</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>name<span class="pl-pds">'</span></span>); <span class="pl-c">// 'Bob Smith'</span>
<span class="pl-smi">user</span>.<span class="pl-c1">name</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>Joe<span class="pl-pds">'</span></span>; <span class="pl-c">// OK</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-c1">name</span>); <span class="pl-c">// 'Joe'</span>
<span class="pl-smi">user</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>friends<span class="pl-pds">'</span></span>, <span class="pl-c1">20</span>); <span class="pl-c">// OK</span>
<span class="pl-smi">user</span>.<span class="pl-smi">friends</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>abc<span class="pl-pds">'</span></span>; <span class="pl-c">// nope. still 20</span>
<span class="pl-smi">user</span>.<span class="pl-smi">dob</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>(<span class="pl-s"><span class="pl-pds">'</span>July 5, 1980<span class="pl-pds">'</span></span>);
<span class="pl-smi">user</span>.<span class="pl-en">get</span>(<span class="pl-s"><span class="pl-pds">'</span>dob<span class="pl-pds">'</span></span>); <span class="pl-c">// instance of Date</span>
<span class="pl-smi">user</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>setup<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>yup<span class="pl-pds">'</span></span>); <span class="pl-c">// nope</span>
<span class="pl-smi">user</span>.<span class="pl-smi">setup</span> <span class="pl-k">=</span> <span class="pl-c1">true</span>; <span class="pl-c">// OK</span></pre></div>

<p><strong>Validation</strong></p>

<p>Lounge does automatic validation against input data using the type information specified in the schema definition.
We can provide custom validation in schema definition by providing <code>validator</code> function.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> validator <span class="pl-k">=</span> <span class="pl-c1">require</span>(<span class="pl-s"><span class="pl-pds">'</span>validator<span class="pl-pds">'</span></span>); <span class="pl-c">// validator module</span>

<span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
  email<span class="pl-k">:</span> {type<span class="pl-k">:</span> <span class="pl-c1">String</span>, validator<span class="pl-k">:</span> <span class="pl-smi">validator</span>.<span class="pl-smi">isEmail</span>}
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({ name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span> });

<span class="pl-smi">user</span>.<span class="pl-smi">email</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>bob@gmail.com<span class="pl-pds">'</span></span>; <span class="pl-c">// OK</span>
<span class="pl-smi">user</span>.<span class="pl-smi">email</span> <span class="pl-k">=</span> <span class="pl-s"><span class="pl-pds">'</span>bsmith<span class="pl-pds">'</span></span>; <span class="pl-c">// Nope</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">email</span>); <span class="pl-c">// 'bob@gmail.com'</span></pre></div>

<p><strong>Virtuals</strong></p>

<p>Virtuals are document properties that you can get and set but that do not get persisted to the database. 
The getters are useful for formatting or combining fields, while setters are useful for de-composing a single value 
into multiple values for storage.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>, 
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">virtual</span>(<span class="pl-s"><span class="pl-pds">'</span>fullName<span class="pl-pds">'</span></span>, {
  <span class="pl-en">get</span><span class="pl-k">:</span> <span class="pl-k">function</span> () {
    <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-smi">firstName</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-v">this</span>.<span class="pl-smi">lastName</span>;
  },
  <span class="pl-en">set</span><span class="pl-k">:</span> <span class="pl-k">function</span> (<span class="pl-smi">v</span>) {
    <span class="pl-k">if</span> (v <span class="pl-k">!==</span> <span class="pl-c1">undefined</span>) {
      <span class="pl-k">var</span> parts <span class="pl-k">=</span> <span class="pl-smi">v</span>.<span class="pl-c1">split</span>(<span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span>);
      <span class="pl-v">this</span>.<span class="pl-smi">firstName</span> <span class="pl-k">=</span> parts[<span class="pl-c1">0</span>];
      <span class="pl-v">this</span>.<span class="pl-smi">lastName</span> <span class="pl-k">=</span> parts[<span class="pl-c1">1</span>];
    }
  }
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({firstName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob<span class="pl-pds">'</span></span>, lastName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Smith<span class="pl-pds">'</span></span>});
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">firstName</span>); <span class="pl-c">// Bob Smith</span></pre></div>

<p>If no <code>set</code> function is defined the virtual is read-only.</p>

<p><strong>Statics</strong></p>

<p>Adding static methods to Models can be accomplished using <code>static()</code> schema function</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>, 
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">static</span>(<span class="pl-s"><span class="pl-pds">'</span>foo<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">p</span>, <span class="pl-smi">q</span>) {
  <span class="pl-k">return</span> p <span class="pl-k">+</span> q;
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-smi">User</span>.<span class="pl-en">foo</span>(<span class="pl-c1">1</span>, <span class="pl-c1">2</span>); <span class="pl-c">// 3</span></pre></div>

<p>We can also pass an object of function keys and function values, and they will all be added.</p>

<p><strong>Methods</strong></p>

<p>Similarly adding instance methods to Models can be done using <code>method()</code> schema function. </p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>, 
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-smi">userSchema</span>.<span class="pl-c1">method</span>(<span class="pl-s"><span class="pl-pds">'</span>fullName<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>() {
  <span class="pl-k">return</span> <span class="pl-v">this</span>.<span class="pl-smi">firstName</span> <span class="pl-k">+</span> <span class="pl-s"><span class="pl-pds">'</span> <span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-v">this</span>.<span class="pl-smi">lastName</span>;
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({firstName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob<span class="pl-pds">'</span></span>, lastName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Smith<span class="pl-pds">'</span></span>});
<span class="pl-smi">user</span>.<span class="pl-en">fullName</span>(); <span class="pl-c">// 'Bob Smith'</span></pre></div>

<p>We can also pass an object of function keys and function values, and they will all be added.</p>

<p><strong>init() method</strong></p>

<p>There is a special <code>init</code> method that if specified in schema definition will be called at the end of model creation. 
You can do additional setup here. This method is not passed in any arguments.</p>

<p><strong>toObject()</strong></p>

<p>Model instances come with <code>toObject</code> function that is automatically used for <code>console.log</code> inspection. </p>

<p>Options:</p>

<ul>
<li>
<code>transform</code> - function used to transform an object once it's been converted to plain javascript representation from a
model instance.</li>
<li>
<code>minimize</code> - to "minimize" the document by removing any empty properties. Default: <code>true</code>
</li>
<li>
<code>virtuals</code> - to apply virtual getters</li>
</ul>

<p>These settings can be applied on any invocation of <code>toObject</code> as well they can be set at schema level.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  password<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-k">var</span> <span class="pl-en">xform</span> <span class="pl-k">=</span> <span class="pl-k">function</span> (<span class="pl-smi">doc</span>, <span class="pl-smi">ret</span>, <span class="pl-smi">options</span>) {
  <span class="pl-k">delete</span> <span class="pl-smi">ret</span>.<span class="pl-smi">password</span>;
  <span class="pl-k">return</span> ret;
};

<span class="pl-smi">userSchema</span>.<span class="pl-en">set</span>(<span class="pl-s"><span class="pl-pds">'</span>toObject<span class="pl-pds">'</span></span>, {transform<span class="pl-k">:</span> xform});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);

<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Joe<span class="pl-pds">'</span></span>,
  email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>joe@gmail.com<span class="pl-pds">'</span></span>,
  password<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>
});

<span class="pl-en">console</span>.<span class="pl-c1">log</span>(user); <span class="pl-c">// { name: 'Joe', email: 'joe@gmail.com' }</span></pre></div>

<p><strong>toJSON()</strong></p>

<p>Similar to <code>toObject</code>. The return value of this method is used in calls to <code>JSON.stringify</code>.</p>

<p><strong>Useful member variables</strong></p>

<p>All model instances come with a <code>modelName</code> read only property that you can use to access the model name. As well
instances have <code>schema</code> property that represents the models schema used when creating the model with <code>model()</code> function.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>});

<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">modelName</span>); <span class="pl-c">// 'User'</span>
<span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">schema</span> isntanceof <span class="pl-smi">lounge</span>.<span class="pl-smi">Schema</span>); <span class="pl-c">// true</span></pre></div>

<p>Since by default models are created using <code>strict</code> mode, Model instances setup and expose an internal <code>$_data</code> variable 
that can be used for any internal storage that's not part of model definition as specified inside of schema. 
This variable is not saved into the database. This can be used in combination with <code>init</code> function:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-smi">userSchema</span>.<span class="pl-c1">method</span>(<span class="pl-s"><span class="pl-pds">'</span>init<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>() {
  <span class="pl-c">// store any logic stuff into $_data</span>
  <span class="pl-v">this</span>.<span class="pl-smi">$_data</span>.<span class="pl-smi">initialEmail</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">email</span>;
  <span class="pl-c">// later we can see if email was changed for example</span>
});</pre></div>

<h3>
<a id="middleware-" class="anchor" href="#middleware-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Middleware <a id="middleware"></a>
</h3>

<p>Similar to Mongoose middleware, Lounge exposes <code>pre</code> and <code>post</code> <a href="https://www.npmjs.com/package/hooks-fixed">hooks</a>.
Normally this is used to do additional validation pre save, and cleanup post document removal. Although the hooks can be
setup for any method including <code>toObject</code> and <code>toJON</code> methods.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  firstName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  lastName<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">pre</span>(<span class="pl-s"><span class="pl-pds">'</span>save<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">next</span>) {
  <span class="pl-k">if</span> (<span class="pl-v">this</span>.<span class="pl-smi">email</span>) {
    <span class="pl-v">this</span>.<span class="pl-smi">email</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">email</span>.<span class="pl-c1">toLowerCase</span>();
  }

  <span class="pl-c">// we must call next to continue control flow </span>
  <span class="pl-en">next</span>();
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">post</span>(<span class="pl-s"><span class="pl-pds">'</span>remove<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> () {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>document %s removed<span class="pl-pds">'</span></span>, <span class="pl-v">this</span>.<span class="pl-c1">id</span>);
});</pre></div>

<p>Important note here is that post 'save' and 'remove' hooks do not receive any form of control flow. There are no
callbacks passed.</p>

<p>The callback passed into pre hooks can be used to control flow of logic:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">schema</span>.<span class="pl-en">pre</span>(<span class="pl-s"><span class="pl-pds">'</span>save<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">next</span>) {
  <span class="pl-c">// some custom validation method</span>
  <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-en">validate</span>()) {
    <span class="pl-k">return</span> <span class="pl-en">next</span>(<span class="pl-k">new</span> <span class="pl-en">Error</span>(<span class="pl-s"><span class="pl-pds">'</span>Validation error!<span class="pl-pds">'</span></span>));
  }

  <span class="pl-en">next</span>();
});

<span class="pl-c">// elsewhere...</span>

<span class="pl-smi">doc</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">savedDoc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err); <span class="pl-c">// 'Validation error!' Document was not saved</span>
});</pre></div>

<h3>
<a id="schema-extension-" class="anchor" href="#schema-extension-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Schema Extension <a id="schema-extend"></a>
</h3>

<p>It is useful to have a common base schema, that all other schemas / models would extend or "inherit" properties from.
This can be accomplished by either using the <code>Schema.extend</code> function. When performed all property definitions, virtuals,
methods, statics, and middleware that are present in the base schema <strong>but not</strong> present in destination schema are copied 
into the destination schema.</p>

<div class="highlight highlight-source-js"><pre> <span class="pl-k">var</span> baseSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  metadata<span class="pl-k">:</span> {
    doc_type<span class="pl-k">:</span> <span class="pl-c1">String</span>,
    createdAt<span class="pl-k">:</span> <span class="pl-c1">Date</span>,
    updatedAt<span class="pl-k">:</span> <span class="pl-c1">Date</span>
  }
});

<span class="pl-smi">baseSchema</span>.<span class="pl-en">pre</span>(<span class="pl-s"><span class="pl-pds">'</span>save<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">next</span>) {
  <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">metadata</span>) {
    <span class="pl-v">this</span>.<span class="pl-smi">metadata</span> <span class="pl-k">=</span> {};
  }

  <span class="pl-k">var</span> now <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">Date</span>();

  <span class="pl-k">if</span> (<span class="pl-k">!</span><span class="pl-v">this</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">createdAt</span>) {
    <span class="pl-v">this</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">createdAt</span> <span class="pl-k">=</span> now;
  }

  <span class="pl-v">this</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">updatedAt</span> <span class="pl-k">=</span> now;
  <span class="pl-v">this</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">doc_type</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">modelName</span>;

  <span class="pl-en">next</span>();
});

<span class="pl-smi">baseSchema</span>.<span class="pl-c1">method</span>(<span class="pl-s"><span class="pl-pds">'</span>baseFoo<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> () {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>base foo<span class="pl-pds">'</span></span>);
});

<span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> <span class="pl-c1">String</span>,
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">pre</span>(<span class="pl-s"><span class="pl-pds">'</span>save<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">next</span>) {
  <span class="pl-k">if</span> (<span class="pl-v">this</span>.<span class="pl-smi">email</span>) {
    <span class="pl-v">this</span>.<span class="pl-smi">email</span> <span class="pl-k">=</span> <span class="pl-v">this</span>.<span class="pl-smi">email</span>.<span class="pl-c1">toLowerCase</span>();
  }

  <span class="pl-en">next</span>();
});

<span class="pl-smi">userSchema</span>.<span class="pl-c1">method</span>(<span class="pl-s"><span class="pl-pds">'</span>userFoo<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> () {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>user foo<span class="pl-pds">'</span></span>);
});

<span class="pl-smi">userSchema</span>.<span class="pl-en">extend</span>(baseSchema);
<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);

user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>,
  email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>BSmith@gmail.com<span class="pl-pds">'</span></span>
});

<span class="pl-smi">user</span>.<span class="pl-en">baseFoo</span>() <span class="pl-c">// prints 'base foo'</span>
<span class="pl-smi">user</span>.<span class="pl-en">userFoo</span>() <span class="pl-c">// prints 'user foo'</span>

<span class="pl-smi">user</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">savedDoc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">updatedAt</span>); <span class="pl-c">// Sat Dec 29 2015 03:30:00 GMT-0400 (AST)</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">metadata</span>.<span class="pl-smi">doc_type</span>); <span class="pl-c">// 'user'</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">email</span>); <span class="pl-c">// 'bsmith@gmail.com'</span>
});</pre></div>

<h3>
<a id="embedded-documents-" class="anchor" href="#embedded-documents-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Embedded Documents <a id="embedded"></a>
</h3>

<p>Lounge allows for embedding and referencing other Models within schema.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> addressSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  street<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  city<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  country<span class="pl-k">:</span> <span class="pl-c1">String</span>
});

<span class="pl-k">var</span> Address <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>Address<span class="pl-pds">'</span></span>, addressSchema);

<span class="pl-k">var</span> blogPostSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  title<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  body<span class="pl-k">:</span> <span class="pl-c1">String</span>,
});

<span class="pl-k">var</span> BlogPost <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>BlogPost<span class="pl-pds">'</span></span>, blogPostSchema);

<span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  address<span class="pl-k">:</span> Address,
  posts<span class="pl-k">:</span> [BlogPost]
});

<span class="pl-k">var</span> post <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">BlogPost</span>({
  title<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Foo<span class="pl-pds">'</span></span>,
  body<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Lorem ipsum<span class="pl-pds">'</span></span>
});

<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>,
  posts<span class="pl-k">:</span> [post],
  address<span class="pl-k">:</span> <span class="pl-k">new</span> <span class="pl-en">Address</span>({
    street<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>123 Fake Street<span class="pl-pds">'</span></span>,
    city<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Springfield<span class="pl-pds">'</span></span>,
    country<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>USA<span class="pl-pds">'</span></span>
  })
});

<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>.<span class="pl-c1">push</span>(<span class="pl-k">new</span> <span class="pl-en">BlogPost</span>({
  title<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Post 2<span class="pl-pds">'</span></span>,
  body<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Some more text!<span class="pl-pds">'</span></span>
});</pre></div>

<p>You can manipulate and work with subdocument just like any model instances. When the top level document is saved
all child sub-documents are saved as well. Subdocuments <strong>must</strong> be an instance of the Model defined in the schema or a 
<code>String</code> in which case it represents the key / id of the subdocument.</p>

<h3>
<a id="saving-documents-" class="anchor" href="#saving-documents-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Saving Documents <a id="saving"></a>
</h3>

<p>Saving documents is done using <code>save</code> function that every model instance has. This will execute all pre 
'save' middleware and then perform Couchbase <code>upsert</code> operation on any subdocuments and the actual document. It will also
perform lookup document updates and finally execute any post hook middleware.</p>

<p>From our example code above:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">user</span>.<span class="pl-en">save</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">savedDoc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
});</pre></div>

<p>All documents and subdocuments would be upserted into the database.</p>

<p><strong>Model.save(data, options, fn)</strong></p>

<p><code>data</code> - any data to be set into the model before saving.</p>

<p><strong>options</strong></p>

<p>All options not present here are first looked up from schema options, and then from config options.</p>

<ul>
<li>
<code>storeFullReferenceId</code> - whether to save embedded document property values as full document keys or just the base value</li>
<li>
<code>storeFullKey</code> - whether to save the internal document key property as fully expanded value or as the simple value</li>
<li>
<code>refIndexKeyPrefix</code> - lookup index document key prefix.</li>
<li>
<code>waitForIndex</code> - whether we want to wait for indexing to finish before returning. default is false.</li>
<li>
<code>virtuals</code> - whether we want to save virtuals. default is <code>false</code>.</li>
<li>
<code>minimize</code> - to "minimize" the document by removing any empty properties. Default: <code>true</code>
</li>
<li>
<code>expiry</code> - couchbase upsert option</li>
<li>
<code>persist_to</code> - couchbase persist_to option</li>
<li>
<code>replicate_to</code> - couchbase option</li>
</ul>

<h3>
<a id="getting-documents-" class="anchor" href="#getting-documents-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Getting Documents <a id="getting"></a>
</h3>

<p>All models created come with a static function <code>findById</code> that can be used to look up a single or multiple keys and 
retrieve documents from the database. If key does not exist and document is not found we <strong>do not</strong> return an error
but also no model is generated. This is different than present couchbase module behaviour.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(<span class="pl-s"><span class="pl-pds">'</span>user123<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err); <span class="pl-c">// there was an error looking up the key</span>
  <span class="pl-k">else</span> <span class="pl-k">if</span>(<span class="pl-k">!</span>doc) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>no document found<span class="pl-pds">'</span></span>);
  <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(doc); <span class="pl-c">// doc is instance of User and will print it out </span>
});</pre></div>

<p>We can get multiple keys using an array as the first parameter. In this case, the callback invoked is passed 3 arguments
in form <code>(err, documents, misses)</code>. </p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>([<span class="pl-s"><span class="pl-pds">'</span>user123<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>user456<span class="pl-pds">'</span></span>], <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">docs</span>, <span class="pl-smi">misses</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err); <span class="pl-c">// there was an error looking up the key</span>
  <span class="pl-en">console</span>.<span class="pl-c1">dir</span>(docs);        <span class="pl-c">// array of Users found</span>
  <span class="pl-en">console</span>.<span class="pl-c1">dir</span>(misses);      <span class="pl-c">// array if keys not found.</span>
});</pre></div>

<p>When <code>findById</code> is invoked using a single string argument the result returned is a single model instance. When an array
is passed in we return the results as described above. To force "array" type of returns in ALL cases, set the Lounge
config option <code>alwaysReturnArrays</code> to <code>true</code>. Default is <code>false</code>.</p>

<h3>
<a id="population-" class="anchor" href="#population-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Population <a id="population"></a>
</h3>

<p><code>findById</code> comes with an options parameter that can have one property <code>populate</code> that can be used to dictate 
if and how we want to get any embedded subdocuments from the database. If <code>populate</code> option is <code>true</code> all embedded 
subdocuments are retrieved from the database.</p>

<p>From our "Embedded Documents" example, if we were to retrieve the user document created:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(userId, {populate<span class="pl-k">:</span> <span class="pl-c1">true</span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">address</span> <span class="pl-k">instanceof</span> Address); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// true</span>

  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user); <span class="pl-c">// full user document with retrieved address and posts subdocuments</span>
});</pre></div>

<p>We can specify a single field to populate:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(userId, {populate<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>address<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">address</span> <span class="pl-k">instanceof</span> Address); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// false </span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> <span class="pl-c1">String</span>); <span class="pl-c">// true - posts is an array of string keys</span>
});</pre></div>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(userId, {populate<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>posts<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">address</span> <span class="pl-k">instanceof</span> Address); <span class="pl-c">// false</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// true</span>
});</pre></div>

<p>We can explicitly specify array indexes to populate</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(userId, {populate<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>posts.1<span class="pl-pds">'</span></span>}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">address</span> <span class="pl-k">instanceof</span> Address); <span class="pl-c">// false</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// false</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> <span class="pl-c1">String</span>); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">1</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// true - fully populated</span>
});</pre></div>

<p>Finally, <code>populate</code> can accept an array if fields to populate:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">User</span>.<span class="pl-en">findById</span>(userId, {populate<span class="pl-k">:</span> [<span class="pl-s"><span class="pl-pds">'</span>address<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>posts.1<span class="pl-pds">'</span></span>]}, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(user <span class="pl-k">instanceof</span> User); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">address</span> <span class="pl-k">instanceof</span> Address); <span class="pl-c">// true - fully populated</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// false</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">0</span>] <span class="pl-k">instanceof</span> <span class="pl-c1">String</span>); <span class="pl-c">// true</span>
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-smi">user</span>.<span class="pl-smi">posts</span>[<span class="pl-c1">1</span>] <span class="pl-k">instanceof</span> BlogPost); <span class="pl-c">// true - fully populated</span>
});</pre></div>

<h3>
<a id="removing-documents-" class="anchor" href="#removing-documents-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Removing Documents <a id="removing"></a>
</h3>

<p>Removing documents is done using <code>remove</code> function that every model instance has. This will execute all pre 
'remove' middleware and then perform Couchbase <code>remove</code> operation. It will also perform lookup document updates 
and finally execute any post hook middleware. By default this function <strong>does not</strong> remove embedded documents. To do
this set <code>removeRefs</code> options to true.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">user</span>.<span class="pl-en">remove</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
});</pre></div>

<p>If we want all subdocuments to be removed:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-smi">user</span>.<span class="pl-en">remove</span>(<span class="pl-k">function</span>(<span class="pl-smi">err</span>, {<span class="pl-smi">removeRefs</span>: <span class="pl-smi">true</span>}, <span class="pl-smi">doc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
});</pre></div>

<p>This will execute removal, hooks and indexing operations for all documents and subdocuments.</p>

<h3>
<a id="indexes-" class="anchor" href="#indexes-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Indexes <a id="indexes"></a>
</h3>

<p>Lounge provides Indexing mechanism using <a href="http://docs.couchbase.com/developer/dev-guide-3.0/lookups.html">reference lookup documents</a>.
This allows us to set up simple one to one lookups for easier document retrieval where we do not need to do create view
indexes. Specifying an index property is done at schema level:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> {type<span class="pl-k">:</span> <span class="pl-c1">String</span>, index<span class="pl-k">:</span> <span class="pl-c1">true</span>}
});</pre></div>

<p>Here we wish <code>User</code> models to have their own <code>id</code> as document key, but we want to be able to look up documents via email
as well as that is also unique property for users. Lounge will automatically manage (remove and upsert) lookup documents,
as user is <code>saved</code> or <code>removed</code>. </p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Joe Smith<span class="pl-pds">'</span></span>,
  email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>joe@gmail.com<span class="pl-pds">'</span></span>
});

<span class="pl-smi">user</span>.<span class="pl-en">save</span>();</pre></div>

<p>This will create the a lookup document similar to:</p>

<pre><code>{ key: '2ba8a471-063b-420a-aa83-31debe58f46f' }
</code></pre>

<p>with document key <code>'$_ref_by_email_joe@gmail.com'</code>. We can manipulate this behaviour using schema options.</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> {type<span class="pl-k">:</span> <span class="pl-c1">String</span>, index<span class="pl-k">:</span> <span class="pl-c1">true</span>}
}, {
  keyPrefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>user::<span class="pl-pds">'</span></span>,
  delimiter<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>::<span class="pl-pds">'</span></span>
});</pre></div>

<p>Saving a document defined with this schema will save user document with key <code>'user::5c4bfd6d-9c80-452b-be3a-3e528e4f53f5'</code>
and will save a lookup document with key <code>''user::$_ref_by_email::joe@gmail.com'</code>. Setting <code>refIndexKeyPrefix</code> can add
additional customization.</p>

<div class="highlight highlight-source-js"><pre>{
  keyPrefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>user::<span class="pl-pds">'</span></span>,
  delimiter<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>::<span class="pl-pds">'</span></span>,
  refIndexKeyPrefix<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>lookup_by_<span class="pl-pds">'</span></span>
}</pre></div>

<p>This will result in lookup document key <code>user::lookup_by_email::joe@gmail.com</code>.</p>

<p>Indexes can also be arrays:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
  usernames<span class="pl-k">:</span> [{type<span class="pl-k">:</span> <span class="pl-c1">String</span>, index<span class="pl-k">:</span> <span class="pl-c1">true</span>}]
});</pre></div>

<p>A lookup document will be generated for each value in the array. Index lookup properties have to be of type <code>String</code> or
<code>Number</code>.</p>

<p>Index lookup documents are automatically managed by lounge when documents are saved and removed using <code>save()</code> and
<code>remove()</code> functions. You can also manually kick of this process by calling <code>index()</code> function on any model instance.</p>

<h3>
<a id="index-queries-" class="anchor" href="#index-queries-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Index queries <a id="queries"></a>
</h3>

<p>Any indexed property the Model will automatically get a <code>findBy*</code> static function for easier lookup. 
For example code above:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);

<span class="pl-smi">User</span>.<span class="pl-en">findByEmail</span>(<span class="pl-s"><span class="pl-pds">'</span>joe@gmail.com<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
  <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(doc);
});</pre></div>

<p>We automatically singularize and camelize property key to derive inde name. So <code>usernames</code> becomes <code>findByUsername</code>.
We can specify the index "name" by passing along "indexName". For example:</p>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>
  usernames<span class="pl-k">:</span> [{type<span class="pl-k">:</span> <span class="pl-c1">String</span>, index<span class="pl-k">:</span> <span class="pl-c1">true</span>, indexName<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>UN<span class="pl-pds">'</span></span>}]
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);

<span class="pl-smi">User</span>.<span class="pl-en">findByUN</span>(<span class="pl-s"><span class="pl-pds">'</span>user1<span class="pl-pds">'</span></span>, <span class="pl-k">function</span>(<span class="pl-smi">err</span>, <span class="pl-smi">doc</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(err);
  <span class="pl-k">else</span> <span class="pl-en">console</span>.<span class="pl-c1">log</span>(doc);
});</pre></div>

<h3>
<a id="events-" class="anchor" href="#events-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Events <a id="events"></a>
</h3>

<p>All model instances inherit <a href="https://nodejs.org/api/events.html#events_class_events_eventemitter"><code>EventEmitter</code></a>, and 
emit three events:</p>

<ul>
<li>
<code>index</code> - when indexing of lookup documents finished regardless if successful or not. Emits <code>error</code> if there was any.</li>
<li>
<code>save</code> - when the document was successfully saved.</li>
<li>
<code>remove</code> - when the document was successfully removed.</li>
</ul>

<div class="highlight highlight-source-js"><pre><span class="pl-k">var</span> userSchema <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">schema</span>({
  name<span class="pl-k">:</span> <span class="pl-c1">String</span>,
  email<span class="pl-k">:</span> {type<span class="pl-k">:</span> <span class="pl-c1">String</span>, index<span class="pl-k">:</span> <span class="pl-c1">true</span>}
});

<span class="pl-k">var</span> User <span class="pl-k">=</span> <span class="pl-smi">lounge</span>.<span class="pl-en">model</span>(<span class="pl-s"><span class="pl-pds">'</span>User<span class="pl-pds">'</span></span>, userSchema);
<span class="pl-k">var</span> user <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-en">User</span>({
  name<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>Bob Smith<span class="pl-pds">'</span></span>,
  email<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>bob@gmail.com<span class="pl-pds">'</span></span>
});

<span class="pl-smi">user</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>index<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">err</span>) {
  <span class="pl-k">if</span>(err) <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>Error indexing document<span class="pl-pds">'</span></span> <span class="pl-k">+</span> <span class="pl-smi">err</span>.<span class="pl-smi">message</span>);
});

<span class="pl-smi">user</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>remove<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>document removed<span class="pl-pds">'</span></span>);
});

<span class="pl-smi">user</span>.<span class="pl-en">on</span>(<span class="pl-s"><span class="pl-pds">'</span>save<span class="pl-pds">'</span></span>, <span class="pl-k">function</span> (<span class="pl-smi">doc</span>) {
  <span class="pl-en">console</span>.<span class="pl-c1">log</span>(<span class="pl-s"><span class="pl-pds">'</span>document saved<span class="pl-pds">'</span></span>);
});</pre></div>

<h2>
<a id="todo" class="anchor" href="#todo" aria-hidden="true"><span class="octicon octicon-link"></span></a>TODO</h2>

<p>See <a href="https://github.com/bojand/lounge/blob/master/TODO.md">TODO.md</a>.</p>

<h2>
<a id="credits" class="anchor" href="#credits" aria-hidden="true"><span class="octicon octicon-link"></span></a>Credits</h2>

<p>Lots of code and design inspired by <a href="http://mongoosejs.com/">Mongoose</a>.
Uses modified version of <a href="https://github.com/jwerle/draft">Draft</a> for schema and modelling.</p>

<h2>
<a id="license" class="anchor" href="#license" aria-hidden="true"><span class="octicon octicon-link"></span></a>License</h2>

<p>Copyright 2015 Bojan Djurkovic</p>

<p>Licensed under the MIT License.</p>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/bojand/lounge">Lounge</a> is maintained by <a href="https://github.com/bojand">bojand</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
